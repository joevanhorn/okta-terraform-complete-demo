name: LowerDeckLabs - Investigate Labels API 405 Error

on:
  workflow_dispatch:

jobs:
  investigate:
    name: Deep Investigation of Labels API
    runs-on: ubuntu-latest

    environment:
      name: LowerDeckLabs

    permissions:
      contents: write
      actions: read

    steps:
      - name: Investigation Overview
        run: |
          echo "=================================================="
          echo "  LABELS API - DEEP INVESTIGATION"
          echo "=================================================="
          echo ""
          echo "Investigating: 405 Method Not Allowed error"
          echo "Endpoint: GET /governance/api/v1/labels/{name}/resources"
          echo ""
          echo "Investigation Plan:"
          echo "  1. Examine label list response structure"
          echo "  2. Test GET /labels/{name}"
          echo "  3. Try all HTTP methods on resources endpoint"
          echo "  4. Check if resources included in label response"
          echo "  5. Try alternative endpoint patterns"
          echo "  6. Check catalog API for label information"
          echo "=================================================="

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Set up environment variables
        env:
          OKTA_API_TOKEN: ${{ secrets.OKTA_API_TOKEN }}
          OKTA_ORG_NAME: ${{ secrets.OKTA_ORG_NAME }}
          OKTA_BASE_URL: ${{ secrets.OKTA_BASE_URL }}
        run: |
          echo "OKTA_ORG_NAME=${OKTA_ORG_NAME}" >> $GITHUB_ENV
          echo "OKTA_BASE_URL=${OKTA_BASE_URL}" >> $GITHUB_ENV
          echo "OKTA_API_TOKEN=${OKTA_API_TOKEN}" >> $GITHUB_ENV

      - name: Run Labels API Investigation
        id: investigate
        run: |
          chmod +x scripts/investigate_labels_api.py
          python3 scripts/investigate_labels_api.py 2>&1 | tee investigation.log
          echo "investigation_complete=true" >> $GITHUB_OUTPUT

      - name: Extract key findings
        id: findings
        run: |
          echo "Analyzing investigation results..."

          # Check if GET /labels/{name} works
          if grep -q "GET /labels/.*Status Code: 200" investigation.log; then
            echo "get_label_works=true" >> $GITHUB_OUTPUT
          else
            echo "get_label_works=false" >> $GITHUB_OUTPUT
          fi

          # Check which methods returned non-405 on resources endpoint
          WORKING_METHODS=$(grep -A 1 "Testing.*---" investigation.log | grep "Status Code: [^4]" | wc -l || echo "0")
          echo "working_methods=$WORKING_METHODS" >> $GITHUB_OUTPUT

          # Check if alternative endpoints found
          if grep -q "SUCCESS! Found working endpoint" investigation.log; then
            echo "alternative_found=true" >> $GITHUB_OUTPUT
          else
            echo "alternative_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload investigation results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: labels-api-investigation-${{ github.run_number }}
          path: |
            investigation.log
          retention-days: 90

      - name: Post detailed summary
        if: always()
        run: |
          echo "## Labels API Investigation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Investigation:** 405 Method Not Allowed error on resources endpoint" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Key Findings" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| GET /labels/{name} works | ${{ steps.findings.outputs.get_label_works }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Working methods on resources | ${{ steps.findings.outputs.working_methods }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Alternative endpoint found | ${{ steps.findings.outputs.alternative_found }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Full Investigation Log" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat investigation.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download artifacts for complete investigation results." >> $GITHUB_STEP_SUMMARY
