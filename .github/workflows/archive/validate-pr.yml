name: Validate Pull Request

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-python:
    name: Validate Python Scripts
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, '.py') || contains(github.event.pull_request.changed_files, '.py')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint requests

      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 scripts/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 scripts/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Check Python syntax
        run: |
          python -m py_compile scripts/*.py

  validate-yaml:
    name: Validate YAML Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate workflow YAML
        run: |
          echo "Validating GitHub workflow files..."
          for file in .github/workflows/*.yml; do
            echo "Checking $file"
            python -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          done

  validate-markdown:
    name: Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check markdown files
        run: |
          echo "Checking for broken markdown links..."
          # Check that all markdown files are valid
          find . -name "*.md" -type f | while read file; do
            echo "Validating $file"
            # Basic validation - file is readable
            cat "$file" > /dev/null || exit 1
          done

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for secrets
        run: |
          echo "Scanning for potential secrets..."

          # Check for common secret patterns
          if grep -r -i "PRIVATE[_-]KEY" --include="*.tf" --include="*.py" --include="*.yml" .; then
            echo "Error: Found potential private key"
            exit 1
          fi

          # Check for hardcoded tokens (excluding template examples)
          if grep -r "OKTA_API_TOKEN.*=" --include="*.tf" --include="*.py" . | grep -v "secrets.OKTA_API_TOKEN" | grep -v "OKTA_API_TOKEN}}" | grep -v "environ.get"; then
            echo "Error: Found hardcoded API token"
            exit 1
          fi

          echo "No obvious secrets found"

      - name: Check for sensitive files
        run: |
          echo "Checking for sensitive files..."

          # Check for terraform state files
          if find . -name "terraform.tfstate" -o -name "terraform.tfstate.backup" | grep -q .; then
            echo "Error: Terraform state files should not be committed"
            exit 1
          fi

          # Check for .env files
          if find . -name ".env" -o -name ".env.local" | grep -q .; then
            echo "Error: Environment files should not be committed"
            exit 1
          fi

          echo "No sensitive files found"

  validate-structure:
    name: Validate Repository Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate directory structure
        run: |
          echo "Validating repository structure..."

          # Check for required directories
          required_dirs=("docs" "scripts" "environments" ".github/workflows")
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "Error: Required directory missing: $dir"
              exit 1
            fi
          done

          echo "Repository structure is valid"

      - name: Check file permissions
        run: |
          echo "Checking file permissions..."

          # Ensure scripts are executable
          find scripts/ -name "*.py" | while read file; do
            if [ ! -x "$file" ]; then
              echo "Warning: Script not executable: $file"
              chmod +x "$file"
            fi
          done

  validate-terraform-fmt:
    name: Terraform Format Check
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, '.tf') || contains(github.event.pull_request.changed_files, '.tf')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"

      - name: Terraform Format Check
        run: |
          echo "Checking Terraform formatting..."
          terraform fmt -check -recursive || {
            echo "Error: Terraform files are not formatted correctly"
            echo "Run 'terraform fmt -recursive' to fix"
            exit 1
          }

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-yaml, security-scan, validate-structure]
    if: always()

    steps:
      - name: Check validation results
        run: |
          echo "Validation Summary:"
          echo "- YAML validation: ${{ needs.validate-yaml.result }}"
          echo "- Security scan: ${{ needs.security-scan.result }}"
          echo "- Structure validation: ${{ needs.validate-structure.result }}"

          if [ "${{ needs.validate-yaml.result }}" != "success" ] || \
             [ "${{ needs.security-scan.result }}" != "success" ] || \
             [ "${{ needs.validate-structure.result }}" != "success" ]; then
            echo "Some validations failed"
            exit 1
          fi

          echo "All validations passed!"
