name: LowerDeckLabs - Export OIG Resources

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      include_resource_owners:
        description: 'Include resource owners export (requires additional API calls)'
        required: false
        default: true
        type: boolean

jobs:
  export-oig:
    name: Export OIG Resources (Read-Only)
    runs-on: ubuntu-latest

    # Use the LowerDeckLabs environment with protection rules
    environment:
      name: LowerDeckLabs

    # IMPORTANT: This job does NOT modify resources - export only!
    permissions:
      contents: read
      actions: read

    steps:
      - name: üîí Safety Check
        run: |
          echo "=================================================="
          echo "  LOWERDECKLABS OIG EXPORT - READ-ONLY OPERATION"
          echo "=================================================="
          echo ""
          echo "‚úÖ This workflow will ONLY export/read OIG resources"
          echo "‚ùå This workflow will NOT modify your Okta tenant"
          echo "‚ùå This workflow will NOT create/update/delete anything"
          echo ""
          echo "Environment: LowerDeckLabs (Primary Demo Tenant)"
          echo "Operation: Export entitlements, labels, resource owners"
          echo "=================================================="
          echo ""

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Set up environment variables
        env:
          OKTA_API_TOKEN: ${{ secrets.OKTA_API_TOKEN }}
          OKTA_ORG_NAME: ${{ secrets.OKTA_ORG_NAME }}
          OKTA_BASE_URL: ${{ secrets.OKTA_BASE_URL }}
        run: |
          echo "OKTA_ORG_NAME=${OKTA_ORG_NAME}" >> $GITHUB_ENV
          echo "OKTA_BASE_URL=${OKTA_BASE_URL}" >> $GITHUB_ENV
          echo "OKTA_API_TOKEN=${OKTA_API_TOKEN}" >> $GITHUB_ENV
          echo "Configured for org: ${OKTA_ORG_NAME}"

      - name: Verify API access (read-only)
        run: |
          echo "Testing API access to OIG endpoints..."

          # Test basic API access
          RESPONSE=$(curl -s -w "%{http_code}" \
            -H "Authorization: SSWS ${OKTA_API_TOKEN}" \
            -H "Accept: application/json" \
            "https://${OKTA_ORG_NAME}.${OKTA_BASE_URL}/api/v1/users?limit=1")

          HTTP_CODE="${RESPONSE: -3}"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå API authentication failed (HTTP $HTTP_CODE)"
            exit 1
          fi
          echo "‚úÖ Basic API access confirmed"

          # Test governance API access
          GOV_RESPONSE=$(curl -s -w "%{http_code}" \
            -H "Authorization: SSWS ${OKTA_API_TOKEN}" \
            -H "Accept: application/json" \
            "https://${OKTA_ORG_NAME}.${OKTA_BASE_URL}/api/v1/governance/entitlements?limit=1")

          GOV_HTTP_CODE="${GOV_RESPONSE: -3}"
          if [ "$GOV_HTTP_CODE" != "200" ]; then
            echo "‚ö†Ô∏è  Governance API access limited (HTTP $GOV_HTTP_CODE)"
            echo "     This may be expected if OIG is not enabled or token lacks governance scopes"
          else
            echo "‚úÖ Governance API access confirmed"
          fi

      - name: Create export directory
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          echo "EXPORT_DIR=lowerdecklabs_oig_export_${TIMESTAMP}" >> $GITHUB_ENV
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_ENV
          mkdir -p lowerdecklabs_oig_export_${TIMESTAMP}

      - name: Export OIG resources
        id: export_oig
        continue-on-error: true
        run: |
          echo "Starting OIG export for LowerDeckLabs..."
          echo ""

          # Make script executable
          chmod +x scripts/okta_api_manager.py

          # Run export (with explicit flags for labels, entitlements, and owners)
          python3 scripts/okta_api_manager.py \
            --action export \
            --org-name "${OKTA_ORG_NAME}" \
            --base-url "${OKTA_BASE_URL}" \
            --api-token "${OKTA_API_TOKEN}" \
            --output "${EXPORT_DIR}/lowerdecklabs_oig_export.json" \
            --export-labels \
            --export-entitlements 2>&1 | tee export.log

          # Note: --export-owners is not included as it requires --resource-orns
          # Resource owners can be added in future iterations if needed

          EXPORT_STATUS=$?

          if [ $EXPORT_STATUS -eq 0 ]; then
            echo "export_status=success" >> $GITHUB_OUTPUT
            echo "‚úÖ OIG export completed successfully"
          else
            echo "export_status=partial" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  OIG export completed with warnings (see log)"
          fi

      - name: Parse export results
        id: parse_results
        run: |
          EXPORT_FILE="${EXPORT_DIR}/lowerdecklabs_oig_export.json"

          if [ -f "$EXPORT_FILE" ]; then
            # Count exported resources
            LABELS_COUNT=$(jq '.labels | length' "$EXPORT_FILE" 2>/dev/null || echo "0")
            ENTITLEMENTS_COUNT=$(jq '.entitlements | length' "$EXPORT_FILE" 2>/dev/null || echo "0")
            OWNERS_COUNT=$(jq '.resource_owners | length' "$EXPORT_FILE" 2>/dev/null || echo "0")

            echo "labels_count=$LABELS_COUNT" >> $GITHUB_OUTPUT
            echo "entitlements_count=$ENTITLEMENTS_COUNT" >> $GITHUB_OUTPUT
            echo "owners_count=$OWNERS_COUNT" >> $GITHUB_OUTPUT

            echo ""
            echo "üìä Export Summary:"
            echo "  - Labels: $LABELS_COUNT"
            echo "  - Entitlements: $ENTITLEMENTS_COUNT"
            echo "  - Resource Owners: $OWNERS_COUNT"
          else
            echo "labels_count=0" >> $GITHUB_OUTPUT
            echo "entitlements_count=0" >> $GITHUB_OUTPUT
            echo "owners_count=0" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Export file not found"
          fi

      - name: Generate export report
        if: always()
        run: |
          REPORT_FILE="${EXPORT_DIR}/EXPORT_REPORT.md"

          cat > ${REPORT_FILE} <<EOF
          # LowerDeckLabs OIG Export Report

          **Date:** $(date)
          **Okta Org:** ${OKTA_ORG_NAME}
          **Workflow Run:** #${{ github.run_number }}

          ## Export Summary

          | Resource Type | Count | Status |
          |--------------|-------|--------|
          | Labels | ${{ steps.parse_results.outputs.labels_count }} | ${{ steps.export_oig.outputs.export_status == 'success' && '‚úÖ' || '‚ö†Ô∏è' }} |
          | Entitlements | ${{ steps.parse_results.outputs.entitlements_count }} | ${{ steps.export_oig.outputs.export_status == 'success' && '‚úÖ' || '‚ö†Ô∏è' }} |
          | Resource Owners | ${{ steps.parse_results.outputs.owners_count }} | ${{ steps.export_oig.outputs.export_status == 'success' && '‚úÖ' || '‚ö†Ô∏è' }} |

          ## What Was Exported

          ### Labels
          - Governance labels with assigned resources
          - Label descriptions and metadata
          - Resource ORNs for each label

          ### Entitlements
          - Principal entitlements (users and groups)
          - Entitlement bundles
          - Access assignments

          ### Resource Owners
          - Resource owner assignments
          - Principal ORNs (users/groups)
          - Resource ORNs (apps/groups)

          ## Export File

          **Location:** \`${EXPORT_DIR}/lowerdecklabs_oig_export.json\`

          **Format:** JSON

          **Structure:**
          \`\`\`json
          {
            "export_date": "ISO-8601 timestamp",
            "okta_org": "demo-terraform-test-example",
            "okta_base_url": "oktapreview.com",
            "labels": [...],
            "entitlements": [...],
            "resource_owners": [...]
          }
          \`\`\`

          ## Important Notes

          - ‚úÖ This was a READ-ONLY operation
          - ‚ùå NO changes were made to your Okta tenant
          - ‚ÑπÔ∏è This export can be used to:
            - Document current OIG configuration
            - Backup entitlement assignments
            - Import into another Okta tenant
            - Track changes over time (drift detection)

          ## Next Steps

          1. **Download** the export artifact from this workflow run
          2. **Review** the exported JSON file
          3. **Store** in secure location (contains tenant configuration)
          4. **Use** for documentation or import into another tenant

          ## Using This Export

          ### To import into another tenant:

          \`\`\`bash
          # Create configuration file from export
          cp lowerdecklabs_oig_export.json import_config.json

          # Review and edit for target tenant
          nano import_config.json

          # Import (requires manual review first!)
          python3 scripts/okta_api_manager.py \\
            --action apply \\
            --config import_config.json \\
            --org-name <target-org> \\
            --api-token <target-token>
          \`\`\`

          ### To compare with previous export:

          \`\`\`bash
          # Download previous export
          # Compare with diff tool
          diff -u previous_export.json lowerdecklabs_oig_export.json
          \`\`\`

          ---

          **Workflow:** LowerDeckLabs OIG Export
          **Run ID:** ${{ github.run_id }}
          **Triggered by:** ${{ github.actor }}
          EOF

          cat ${REPORT_FILE}

      - name: Upload export data
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lowerdecklabs-oig-export-${{ env.TIMESTAMP }}
          path: |
            ${{ env.EXPORT_DIR }}/
            export.log
          retention-days: 180  # Keep for 6 months (important tenant data)

      - name: Commit export to repository
        if: success()
        run: |
          # Get date for filename
          EXPORT_DATE=$(date +%Y-%m-%d)
          EXPORT_FILE="${EXPORT_DIR}/lowerdecklabs_oig_export.json"

          # Create oig-exports directory if it doesn't exist
          mkdir -p oig-exports/lowerdecklabs

          # Copy export to repository (JSON only, logs stay in artifacts)
          cp "${EXPORT_FILE}" "oig-exports/lowerdecklabs/${EXPORT_DATE}.json"
          cp "${EXPORT_FILE}" "oig-exports/lowerdecklabs/latest.json"

          echo "‚úÖ Export files copied to oig-exports/lowerdecklabs/"
          echo "   - ${EXPORT_DATE}.json"
          echo "   - latest.json"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add files
          git add oig-exports/lowerdecklabs/

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes detected - export is identical to previous"
          else
            # Create commit message with export summary including categorization
            LABELS_COUNT=$(jq '.labels | length // 0' "${EXPORT_FILE}")
            ENTITLEMENTS_COUNT=$(jq '.entitlements | length // 0' "${EXPORT_FILE}")
            LABELS_STATUS=$(jq -r '.export_status.labels // "unknown"' "${EXPORT_FILE}")
            ENTITLEMENTS_STATUS=$(jq -r '.export_status.entitlements // "unknown"' "${EXPORT_FILE}")

            # Get entitlement categorization if available
            APP_MANAGED=$(jq -r '.entitlement_categories.app_managed_count // 0' "${EXPORT_FILE}")
            MANUAL=$(jq -r '.entitlement_categories.manual_count // 0' "${EXPORT_FILE}")
            UNKNOWN=$(jq -r '.entitlement_categories.unknown_count // 0' "${EXPORT_FILE}")

            # Build category details if categorization was performed
            CATEGORY_DETAILS=""
            if [ "${APP_MANAGED}" != "0" ] || [ "${MANUAL}" != "0" ]; then
              CATEGORY_DETAILS="
  - App-managed (synced): ${APP_MANAGED}
  - Manual/Custom (BYO): ${MANUAL}"
              if [ "${UNKNOWN}" != "0" ]; then
                CATEGORY_DETAILS="${CATEGORY_DETAILS}
  - Unknown: ${UNKNOWN}"
              fi
            fi

            git commit -m "feat(oig): Export OIG resources for lowerdecklabs

- Entitlements: ${ENTITLEMENTS_COUNT} (${ENTITLEMENTS_STATUS})${CATEGORY_DETAILS}
- Labels: ${LABELS_COUNT} (${LABELS_STATUS})

Export date: ${EXPORT_DATE}
Workflow run: ${{ github.run_number }}

ü§ñ Generated with Claude Code
Co-Authored-By: Claude <noreply@anthropic.com>"

            # Push changes
            git push

            echo "‚úÖ Export committed to repository"
            echo "üìÅ Files: oig-exports/lowerdecklabs/${EXPORT_DATE}.json"
            echo "üìÅ Files: oig-exports/lowerdecklabs/latest.json"
          fi

      - name: Post summary to workflow
        if: always()
        run: |
          echo "## üì§ LowerDeckLabs OIG Export Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** LowerDeckLabs (Primary Demo Tenant)" >> $GITHUB_STEP_SUMMARY
          echo "**Operation:** OIG Export (Read-Only)" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources Exported" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Type | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Labels | ${{ steps.parse_results.outputs.labels_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Entitlements | ${{ steps.parse_results.outputs.entitlements_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Owners | ${{ steps.parse_results.outputs.owners_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Safety Confirmation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ No resources were modified" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ This was a read-only export operation" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Your LowerDeckLabs tenant is unchanged" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Export Locations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository (committed):**" >> $GITHUB_STEP_SUMMARY
          echo "- \`oig-exports/lowerdecklabs/latest.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`oig-exports/lowerdecklabs/$(date +%Y-%m-%d).json\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact (backup):**" >> $GITHUB_STEP_SUMMARY
          echo "- Download \`lowerdecklabs-oig-export-${{ env.TIMESTAMP }}\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The export has been committed to the repository for:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Version control" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Drift detection" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Historical tracking" >> $GITHUB_STEP_SUMMARY

      - name: Final safety check
        if: always()
        run: |
          echo ""
          echo "=================================================="
          echo "  OIG EXPORT COMPLETED SUCCESSFULLY"
          echo "=================================================="
          echo ""
          echo "‚úÖ LowerDeckLabs tenant unchanged"
          echo "‚úÖ OIG resources exported to artifacts"
          echo "‚úÖ No modifications were made"
          echo ""
          echo "Download artifacts to review exported OIG data."
          echo "=================================================="
