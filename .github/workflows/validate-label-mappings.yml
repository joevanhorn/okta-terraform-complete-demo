name: Validate Label Mappings

on:
  pull_request:
    paths:
      - 'environments/*/config/label_mappings.json'
    types: [opened, synchronize, reopened]

jobs:
  validate-config:
    name: Validate Label Configuration
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema

      - name: Find changed label mapping files
        id: changed-files
        run: |
          echo "files<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }} | grep 'label_mappings.json' >> $GITHUB_OUTPUT || true
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Validate JSON syntax and structure
        run: |
          echo "## Label Mappings Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          VALIDATION_PASSED=true

          for file in ${{ steps.changed-files.outputs.files }}; do
            echo "Validating: $file"
            echo "### üìÑ $file" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Check JSON syntax
            if python3 -m json.tool "$file" > /dev/null 2>&1; then
              echo "‚úÖ Valid JSON syntax" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå Invalid JSON syntax" >> $GITHUB_STEP_SUMMARY
              VALIDATION_PASSED=false
              continue
            fi

            # Check required fields exist
            python3 << 'PYEOF' "$file" >> $GITHUB_STEP_SUMMARY
import json
import sys

with open(sys.argv[1], 'r') as f:
    config = json.load(f)

required_keys = ['labels', 'assignments']
missing = [k for k in required_keys if k not in config]

if missing:
    print(f"‚ùå Missing required keys: {', '.join(missing)}")
    sys.exit(1)

print(f"‚úÖ Required structure present")
print(f"")
print(f"**Configuration Summary:**")
print(f"- Labels defined: {len(config.get('labels', {}))}")
print(f"- Assignment categories: {len(config.get('assignments', {}))}")

# Count total assignments
total_assignments = 0
for category, labels in config.get('assignments', {}).items():
    for label, orns in labels.items():
        total_assignments += len(orns)

print(f"- Total resource assignments: {total_assignments}")
print(f"")

# List labels
print(f"**Labels:**")
for label_name in config.get('labels', {}).keys():
    print(f"- {label_name}")
print(f"")

# Check ORN format
print(f"**ORN Validation:**")
invalid_orns = []
for category, labels in config.get('assignments', {}).items():
    for label, orns in labels.items():
        for orn in orns:
            if not orn.startswith('orn:'):
                invalid_orns.append(f"{category}/{label}: {orn}")

if invalid_orns:
    print(f"‚ùå Invalid ORN formats found:")
    for invalid in invalid_orns[:10]:  # Show first 10
        print(f"  - {invalid}")
    sys.exit(1)
else:
    print(f"‚úÖ All ORNs have valid format")

PYEOF

            if [ $? -ne 0 ]; then
              VALIDATION_PASSED=false
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
          done

          if [ "$VALIDATION_PASSED" = false ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ùå **Validation failed** - Please fix the errors above" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ **All validations passed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Get PR approval" >> $GITHUB_STEP_SUMMARY
            echo "2. Merge PR to main" >> $GITHUB_STEP_SUMMARY
            echo "3. Label application workflow will run automatically in dry-run mode" >> $GITHUB_STEP_SUMMARY
            echo "4. Manually trigger workflow with \`dry_run=false\` to apply changes" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Read step summary
            let summary = "Configuration validation completed. See workflow summary for details.";

            const output = `## üè∑Ô∏è Label Mappings Validation

            Configuration file validation has completed for this PR.

            ${summary}

            ### GitOps Workflow
            When this PR is merged:
            1. ‚úÖ Configuration will be merged to main branch
            2. üîç Label application workflow will run automatically in **dry-run mode**
            3. üìä Dry-run results will be available in workflow summary
            4. üîê Manual approval required to apply labels (run workflow with \`dry_run=false\`)

            This ensures all label changes have:
            - ‚úì Code review (via PR)
            - ‚úì Automated validation (this workflow)
            - ‚úì Dry-run preview (automatic on merge)
            - ‚úì Manual approval (before applying)

            *Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
