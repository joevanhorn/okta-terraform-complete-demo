name: LowerDeckLabs - Import OIG Resources

on:
  workflow_dispatch:
    inputs:
      update_terraform:
        description: 'Update production-ready TF files with imported resources'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  import-oig:
    name: Import OIG Resources from Okta
    runs-on: ubuntu-latest

    environment:
      name: LowerDeckLabs

    permissions:
      contents: write
      actions: read

    steps:
      - name: Workflow Overview
        run: |
          echo "=================================================="
          echo "  IMPORT OIG RESOURCES"
          echo "=================================================="
          echo ""
          echo "Environment: LowerDeckLabs (Primary Demo Tenant)"
          echo "Operation: Import entitlement bundle definitions from Okta"
          echo "Update Terraform: ${{ github.event.inputs.update_terraform }}"
          echo ""
          echo "NOTE: This imports BUNDLE DEFINITIONS only."
          echo "Principal assignments (grants) are NOT imported and"
          echo "should be managed in Okta Admin UI or via API."
          echo "=================================================="

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Set up environment variables
        env:
          OKTA_API_TOKEN: ${{ secrets.OKTA_API_TOKEN }}
          OKTA_ORG_NAME: ${{ secrets.OKTA_ORG_NAME }}
          OKTA_BASE_URL: ${{ secrets.OKTA_BASE_URL }}
        run: |
          echo "OKTA_ORG_NAME=${OKTA_ORG_NAME}" >> $GITHUB_ENV
          echo "OKTA_BASE_URL=${OKTA_BASE_URL}" >> $GITHUB_ENV
          echo "OKTA_API_TOKEN=${OKTA_API_TOKEN}" >> $GITHUB_ENV

      - name: Run OIG import
        id: import
        run: |
          chmod +x scripts/import_oig_resources.py
          mkdir -p oig-imports

          echo "Running OIG resource import..."
          python3 scripts/import_oig_resources.py --output-dir oig-imports 2>&1 | tee import.log

          IMPORT_STATUS=$?
          echo "import_status=$IMPORT_STATUS" >> $GITHUB_OUTPUT

      - name: Parse results
        id: results
        run: |
          if [ -f "oig-imports/entitlements.json" ]; then
            BUNDLES=$(jq '. | length' oig-imports/entitlements.json 2>/dev/null || echo "0")
          else
            BUNDLES=0
          fi

          echo "bundles=$BUNDLES" >> $GITHUB_OUTPUT
          echo "Imported $BUNDLES entitlement bundles"

      - name: Update Terraform files
        if: github.event.inputs.update_terraform == 'true'
        run: |
          echo "Updating production-ready Terraform files..."
          mkdir -p production-ready
          if [ -f "production-ready/oig_entitlements.tf" ]; then
            cp production-ready/oig_entitlements.tf production-ready/oig_entitlements.tf.backup
          fi
          if [ -f "oig-imports/entitlements.tf" ]; then
            cp oig-imports/entitlements.tf production-ready/oig_entitlements.tf
            echo "âœ… Updated production-ready/oig_entitlements.tf"
          fi
          cp oig-imports/*.json production-ready/ 2>/dev/null || true

          echo "Updating LowerDeckLabs terraform directory..."
          if [ -f "oig-imports/entitlements.tf" ]; then
            cp oig-imports/entitlements.tf environments/lowerdecklabs/terraform/oig_entitlements.tf
            echo "âœ… Updated environments/lowerdecklabs/terraform/oig_entitlements.tf"
          fi

      - name: Setup Terraform for Import
        if: github.event.inputs.update_terraform == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"

      - name: Import Resources into Terraform State
        if: github.event.inputs.update_terraform == 'true'
        working-directory: environments/lowerdecklabs/terraform
        run: |
          # Configure Terraform variables
          cat > terraform.tfvars << EOF
          okta_org_name  = "${{ secrets.OKTA_ORG_NAME }}"
          okta_base_url  = "${{ secrets.OKTA_BASE_URL }}"
          okta_api_token = "${{ secrets.OKTA_API_TOKEN }}"
          EOF

          # Initialize Terraform
          terraform init -upgrade

          # Check if import.sh exists from the import script
          if [ -f "../../../oig-imports/import.sh" ]; then
            echo "Using import commands from import script..."
            cp ../../../oig-imports/import.sh ./
          else
            echo "Generating import commands from terraform config..."
            python3 <<'PYTHON'
          import re

          with open('oig_entitlements.tf', 'r') as f:
              content = f.read()

          pattern = r'resource "okta_entitlement_bundle" "([^"]+)"[^}]*?target_resource_orn\s*=\s*"orn:okta:governance:[^:]+:entitlement-bundles:([^"]+)"'
          matches = re.findall(pattern, content, re.DOTALL)

          with open('import.sh', 'w') as f:
              f.write('#!/bin/bash\n')
              f.write('set +e\n\n')  # Don't exit on error for imports
              f.write(f'echo "Importing {len(matches)} OIG entitlement bundles..."\n')
              f.write('echo ""\n\n')

              for i, (resource_name, bundle_id) in enumerate(matches, 1):
                  f.write(f'echo "Importing {i}/{len(matches)}: okta_entitlement_bundle.{resource_name}"\n')
                  f.write(f'terraform import okta_entitlement_bundle.{resource_name} {bundle_id} 2>&1 | grep -v "Error: resource already exists" || true\n')
                  f.write('echo ""\n\n')

          print(f'Generated import commands for {len(matches)} resources')
          PYTHON
          fi

          chmod +x import.sh
          ./import.sh 2>&1 | tee import.log

          # Count imported resources
          IMPORTED=$(terraform state list | grep okta_entitlement_bundle | wc -l | tr -d ' ')
          echo "âœ… Imported $IMPORTED entitlement bundles into terraform state"

          # Clean up sensitive files
          rm -f terraform.tfvars
          rm -f import.sh

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: oig-import-results-${{ github.run_number }}
          path: |
            oig-imports/
            import.log
          retention-days: 180

      - name: Create PR with imported state
        if: github.event.inputs.update_terraform == 'true' && success()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes to commit
          git add production-ready/oig_entitlements.tf
          git add production-ready/*.json 2>/dev/null || true
          git add environments/lowerdecklabs/terraform/oig_entitlements.tf
          git add -f environments/lowerdecklabs/terraform/terraform.tfstate
          git add environments/lowerdecklabs/terraform/.terraform.lock.hcl

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Create a new branch
          BRANCH_NAME="import-oig-state-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"

          # Commit changes
          git commit -m "$(cat <<'EOF'
          feat(oig): Import entitlement bundles from Okta into Terraform

          Imported ${{ steps.results.outputs.bundles }} entitlement bundle definitions
          from Okta and populated terraform state.

          Changes:
          - Generated Terraform configs from Okta API
          - Imported resources into terraform state
          - Terraform now manages these OIG resources

          NOTE: Principal assignments (grants) are managed in Okta Admin UI.

          ðŸ¤– Auto-generated by workflow

          EOF
          )"

          # Push branch
          git push -u origin "$BRANCH_NAME"

          # Create PR
          gh pr create \
            --title "feat(oig): Import ${{ steps.results.outputs.bundles }} entitlement bundles into Terraform state" \
            --body "$(cat <<'EOF'
          ## Summary

          This PR imports **${{ steps.results.outputs.bundles }} OIG entitlement bundles** from Okta into Terraform state management.

          ### Changes

          - âœ… Generated Terraform configurations from Okta API
          - âœ… Imported all entitlement bundles into `terraform.tfstate`
          - âœ… Terraform now manages these OIG resources
          - âœ… Added terraform.tfstate file (intentionally tracked for this demo)

          ### Files Changed

          - `environments/lowerdecklabs/terraform/terraform.tfstate` - New state file with 31 imported bundles
          - `environments/lowerdecklabs/terraform/oig_entitlements.tf` - Updated configurations
          - `production-ready/oig_entitlements.tf` - Production-ready version

          ### Verification

          After merging, run `terraform plan` to verify no drift:
          ```bash
          cd environments/lowerdecklabs/terraform
          terraform plan
          ```

          Expected output: `Plan: 0 to add, 0 to change, 0 to destroy`

          ---

          ðŸ¤– Auto-generated by [OIG Import Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          EOF
          )" \
            --base main \
            --head "$BRANCH_NAME"

          echo "âœ… Pull request created successfully"
          echo "PR_CREATED=true" >> $GITHUB_OUTPUT

      - name: Post summary
        if: always()
        run: |
          echo "## OIG Import Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** LowerDeckLabs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources Imported" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Type | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Entitlement Bundles | ${{ steps.results.outputs.bundles }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.update_terraform }}" == "true" ]; then
            echo "âœ… **Pull Request Created**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A pull request has been created with:" >> $GITHUB_STEP_SUMMARY
            echo "- Imported terraform state file" >> $GITHUB_STEP_SUMMARY
            echo "- Updated terraform configurations" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:** Review and merge the PR to persist the terraform state" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸  **Terraform files NOT updated** (update_terraform=false)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To update Terraform files, re-run with update_terraform=true" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ Download artifacts to review imported resources" >> $GITHUB_STEP_SUMMARY
